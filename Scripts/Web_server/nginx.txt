worker_processes  auto;  # Автоматическое определение количества ядер CPU

events {
    worker_connections  1024;
    multi_accept on;  # Принимать несколько соединений одновременно
}

http {
    # Базовые настройки для загрузки файлов
    client_max_body_size 100M;  # Максимальный размер загружаемого файла (100MB)
    client_body_buffer_size 128k;  # Размер буфера для тела запроса
    client_body_temp_path C:/Users/Администратор/Desktop/Сервер/Web_server;  # Путь для временных файлов загрузки
    client_header_buffer_size 16k;  # Размер буфера заголовков
    large_client_header_buffers 4 32k;  # Буферы для больших заголовков

    # Таймауты (важно для больших файлов)
    client_body_timeout 300s;
    client_header_timeout 300s;
    keepalive_timeout 75s;
    send_timeout 300s;

    server {
        listen 443 ssl;
        server_name 46.148.52.244;

        # SSL сертификаты (исправьте пути)
        ssl_certificate C:/Users/Администратор/Desktop/Сервер/Web_server/server.crt;  # Рекомендую английские пути
        ssl_certificate_key C:/Users/Администратор/Desktop/Сервер/Web_server/server.key;

        # Оптимизированные SSL настройки
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 24h;
        ssl_session_tickets on;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers on;
        ssl_buffer_size 16k;

        # Проксирование на Flask
        location / {
            proxy_pass http://127.0.0.1:5000;

            # Важные заголовки
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port $server_port;

            # Настройки для больших файлов
            proxy_request_buffering off;  # Отключаем буферизацию запросов
            proxy_max_temp_file_size 0;   # Отключаем временные файлы
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;

            # WebSocket поддержка (если нужно)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

    # HTTP → HTTPS редирект
    server {
        listen 8080;
        server_name 46.148.52.244;

        # Увеличиваем лимиты и для HTTP
        client_max_body_size 100M;
        client_body_buffer_size 128k;

        return